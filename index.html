<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir Kekinian - Outlet Anda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .hidden { display: none; }
        
        /* --- Splash Screen Styles & Animations --- */
        #splash-screen {
            position: fixed;
            inset: 0;
            z-index: 100;
            background-color: #111827;
            transition: opacity 0.5s ease-in-out;
        }
        .splash-content {
            animation: fadeInUp 0.8s ease-out;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* --- End Splash Screen Styles --- */

        .modal-enter { animation: fadeIn 0.3s ease-out; }
        .modal-leave { animation: fadeOut 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- ===== SPLASH SCREEN (TAMPILAN AWAL) ===== -->
    <div id="splash-screen" class="flex flex-col items-center justify-center">
        <div class="splash-content text-center">
            <i data-lucide="utensils-crossed" class="w-20 h-20 mx-auto text-emerald-400 mb-6"></i>
            <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent mb-2">
                Selamat Datang
            </h1>
            <p class="text-lg text-gray-400 mb-8">DAPUR OMAH</p>
            <p class="text-lg text-gray-400 mb-8">Wa: 088228665260</p>
            <button id="enter-app-btn" class="bg-emerald-500 text-white font-bold py-3 px-10 rounded-full text-lg hover:bg-emerald-600 transition-all transform hover:scale-105 shadow-lg shadow-emerald-500/20">
                Mulai Pesan
            </button>
        </div>
    </div>
    <!-- ===== END SPLASH SCREEN ===== -->


    <!-- ===== MAIN APP CONTAINER (Initially hidden) ===== -->
    <div id="app" class="max-w-4xl mx-auto min-h-screen hidden">
        <!-- ===== HEADER ===== -->
        <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-30 p-4 border-b border-gray-700 flex justify-between items-center">
            <div class="flex items-center gap-4">
                 <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent">
                    DAPUR OMAH
                </h1>
            </div>
            <button id="cart-button" class="relative rounded-full p-2 hover:bg-gray-700 transition-colors">
                <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                <span id="cart-count-badge" class="absolute -top-1 -right-1 bg-emerald-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
            </button>
        </header>

        <main class="p-4">
            <!-- ===== MENU VIEW ===== -->
            <div id="menu-view">
                <!-- Category Filters -->
                <div class="flex space-x-2 mb-6 overflow-x-auto pb-2">
                    <button data-category="all" class="category-btn bg-emerald-500 text-white px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap">Semua</button>
                    <button data-category="makanan" class="category-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap">Makanan</button>
                    <button data-category="minuman" class="category-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap">Minuman</button>
                    <button data-category="snack" class="category-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap">Snack</button>
                </div>

                <!-- Product Grid -->
                <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    <!-- Loading state -->
                    <p id="loading-message" class="col-span-full text-center text-gray-400 py-10">Memuat menu...</p>
                </div>
            </div>

            <!-- ===== CART VIEW ===== -->
            <div id="cart-view" class="hidden">
                <div class="flex items-center gap-4 mb-6">
                    <button id="back-to-menu-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i>
                    </button>
                    <h2 class="text-2xl font-bold">Keranjang Belanja</h2>
                </div>
                <div id="cart-items-container"></div>
                <div id="cart-summary" class="mt-8 pt-4 border-t border-gray-700 hidden">
                    <div class="space-y-2 text-lg">
                        <div class="flex justify-between">
                            <span>Subtotal</span>
                            <span id="subtotal-amount">Rp 0</span>
                        </div>
                        <div class="flex justify-between font-bold text-xl">
                            <span>Total</span>
                            <span id="total-amount">Rp 0</span>
                        </div>
                    </div>
                    <button id="checkout-btn" class="w-full mt-6 bg-emerald-500 text-white py-3 rounded-lg font-bold text-lg hover:bg-emerald-600 transition-all flex items-center justify-center gap-2">
                        <span>Lanjutkan ke Pembayaran</span>
                        <i data-lucide="arrow-right"></i>
                    </button>
                </div>
                <div id="empty-cart-message" class="text-center py-16">
                    <i data-lucide="shopping-basket" class="w-16 h-16 mx-auto text-gray-500 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-400">Keranjangmu masih kosong</h3>
                    <p class="text-gray-500">Yuk, pilih menu favoritmu!</p>
                </div>
            </div>

            <!-- ===== PAYMENT VIEW ===== -->
            <div id="payment-view" class="hidden">
                 <div class="flex items-center gap-4 mb-6">
                    <button id="back-to-cart-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i>
                    </button>
                    <h2 class="text-2xl font-bold">Pembayaran</h2>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="font-bold text-lg mb-4">Ringkasan Pesanan</h3>
                    <div class="flex justify-between text-xl font-bold mb-6">
                        <span>Total Tagihan:</span>
                        <span id="payment-total-amount" class="text-emerald-400">Rp 0</span>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="customer-name" class="block text-sm font-medium text-gray-400 mb-1">Nama Pelanggan</label>
                            <input type="text" id="customer-name" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Contoh: Budi">
                        </div>
                         <div>
                            <label for="customer-phone" class="block text-sm font-medium text-gray-400 mb-1">Nomor WhatsApp</label>
                            <input type="tel" id="customer-phone" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Contoh: 081234567890">
                        </div>
                    </div>
                    <h3 class="font-bold text-lg mt-6 mb-4">Jenis Pesanan</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <button data-type="dine-in" class="order-type-btn flex flex-col items-center justify-center p-3 bg-gray-700 rounded-lg border-2 border-transparent ring-2 ring-emerald-500">
                            <i data-lucide="utensils" class="w-6 h-6 mb-1"></i>
                            <span class="font-semibold text-sm">Makan di Tempat</span>
                        </button>
                        <button data-type="take-out" class="order-type-btn flex flex-col items-center justify-center p-3 bg-gray-700 rounded-lg border-2 border-transparent">
                            <i data-lucide="shopping-bag" class="w-6 h-6 mb-1"></i>
                            <span class="font-semibold text-sm">Bawa Pulang</span>
                        </button>
                        <button data-type="delivery" class="order-type-btn flex flex-col items-center justify-center p-3 bg-gray-700 rounded-lg border-2 border-transparent">
                            <i data-lucide="truck" class="w-6 h-6 mb-1"></i>
                            <span class="font-semibold text-sm">Pengiriman</span>
                        </button>
                    </div>
                    <div id="delivery-address-container" class="mt-4 hidden">
                        <label for="delivery-address" class="block text-sm font-medium text-gray-400 mb-1">Alamat Pengiriman</label>
                        <textarea id="delivery-address" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Masukkan alamat lengkap..."></textarea>
                    </div>

                    <!-- Payment Notice for Delivery -->
                    <div id="delivery-payment-notice" class="mt-4 bg-yellow-900/50 border border-yellow-700 text-yellow-300 text-sm rounded-lg p-3 hidden">
                        <div class="flex items-start gap-3">
                            <i data-lucide="info" class="w-5 h-5 flex-shrink-0 mt-0.5"></i>
                            <p>Untuk pesanan dengan pengiriman, mohon selesaikan pembayaran terlebih dahulu agar pesanan Anda dapat segera kami proses.</p>
                        </div>
                    </div>

                    <h3 class="font-bold text-lg mt-6 mb-4">Pilih Metode Pembayaran</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button data-payment="cash" class="payment-method-btn flex flex-col items-center justify-center p-4 bg-gray-700 rounded-lg border-2 border-transparent ring-2 ring-emerald-500 transition-opacity">
                            <i data-lucide="wallet" class="w-8 h-8 mb-2"></i>
                            <span class="font-semibold">Cash / Tunai</span>
                        </button>
                        <button data-payment="transfer" class="payment-method-btn flex flex-col items-center justify-center p-4 bg-gray-700 rounded-lg border-2 border-transparent">
                            <i data-lucide="landmark" class="w-8 h-8 mb-2"></i>
                            <span class="font-semibold">Bank Transfer</span>
                        </button>
                    </div>
                   <div id="transfer-info" class="mt-4 bg-gray-900 p-4 rounded-md hidden text-center">
                       <p class="font-semibold text-white text-lg mb-2">Silakan lakukan pembayaran dengan memindai kode QRIS berikut:</p>

                        <img src="https://i.imgur.com/cv5MwBp.png" 
                             alt="Kode QRIS Pembayaran" 
                             class="mx-auto rounded-lg w-full max-w-xs h-auto border-4 border-gray-600 my-4">

                        <p class="text-gray-300">Atas nama: <span class="font-semibold">Sudarto</span></p>

                        <button id="close-qris-btn" 
                                class="w-full mt-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                    </div>
                    <button id="confirm-order-btn" class="w-full mt-8 bg-emerald-500 text-white py-3 rounded-lg font-bold text-lg hover:bg-emerald-600 transition-all flex items-center justify-center gap-2 disabled:bg-gray-500 disabled:cursor-not-allowed">
                        <span id="confirm-btn-text">Kirim Pesanan</span>
                        <div id="confirm-btn-loader" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin hidden"></div>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden modal-enter">
        <div class="bg-gray-800 rounded-lg p-8 text-center max-w-sm mx-4">
            <div class="w-16 h-16 bg-emerald-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="check" class="w-12 h-12 text-white"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">Pesanan Diterima!</h2>
            <p class="text-gray-400 mb-6">Pesanan Anda telah kami terima dan sedang menunggu konfirmasi dari penjual.</p>
            <p class="text-gray-400 mb-6">Atau untuk lebih cepat, silahkan hubungi admin (088228665260). Terima Kasih!</p>
            <button id="close-modal-btn" class="bg-emerald-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-emerald-600 transition-colors">Selesai</button>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // =================================================================================
        // KONFIGURASI PENTING (WAJIB DIISI)
        // =================================================================================
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwIC5iHvtUj7pJa8Ffp96l-L1uJAMIODFpfBgck3JCGO7jjH819843J6TTSVzb6Gid94Q/exec'; // <-- ISI DENGAN URL WEB APP ANDA
        const YOUR_WHATSAPP_NUMBER = '6285225466047'; // <-- GANTI DENGAN NOMOR WA ANDA
        // =================================================================================

        const state = {
            products: [],
            cart: [],
            currentView: 'menu',
            paymentMethod: 'cash',
            orderType: 'dine-in',
        };

        // DOM Elements
        const splashScreen = document.getElementById('splash-screen');
        const enterAppBtn = document.getElementById('enter-app-btn');
        const appContainer = document.getElementById('app');
        
        const productGrid = document.getElementById('product-grid');
        const categoryBtns = document.querySelectorAll('.category-btn');
        const cartButton = document.getElementById('cart-button');
        const cartCountBadge = document.getElementById('cart-count-badge');

        const menuView = document.getElementById('menu-view');
        const cartView = document.getElementById('cart-view');
        const paymentView = document.getElementById('payment-view');
        
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const backToCartBtn = document.getElementById('back-to-cart-btn');
        const checkoutBtn = document.getElementById('checkout-btn');
        
        const cartItemsContainer = document.getElementById('cart-items-container');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const cartSummary = document.getElementById('cart-summary');
        const subtotalAmountEl = document.getElementById('subtotal-amount');
        const totalAmountEl = document.getElementById('total-amount');
        
        const paymentTotalAmountEl = document.getElementById('payment-total-amount');
        const paymentMethodBtns = document.querySelectorAll('.payment-method-btn');
        const orderTypeBtns = document.querySelectorAll('.order-type-btn');
        const deliveryAddressContainer = document.getElementById('delivery-address-container');
        const deliveryAddressInput = document.getElementById('delivery-address');
        const deliveryPaymentNotice = document.getElementById('delivery-payment-notice');
        const transferInfo = document.getElementById('transfer-info');
        const confirmOrderBtn = document.getElementById('confirm-order-btn');
        const customerNameInput = document.getElementById('customer-name');
        const customerPhoneInput = document.getElementById('customer-phone');
        
        const successModal = document.getElementById('success-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');

        // --- App Initialization ---
        const initApp = () => {
            splashScreen.style.opacity = '0';
            setTimeout(() => {
                splashScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
            }, 500);
        };
        enterAppBtn.addEventListener('click', initApp);

        const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);

        const formatWhatsappNumber = (phone) => {
            if (!phone || typeof phone !== 'string') return '';
            let digitsOnly = phone.replace(/\D/g, '');
            if (digitsOnly.startsWith('62')) return digitsOnly;
            if (digitsOnly.startsWith('0')) return '62' + digitsOnly.substring(1);
            if (digitsOnly.length > 8) return '62' + digitsOnly;
            return digitsOnly;
        };

        const robustJsonFetch = async (url) => {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
            }
            const text = await response.text();
            try {
                return JSON.parse(text);
            } catch (e) {
                console.error("Gagal mem-parsing JSON dari server:", text);
                throw new Error("Menerima data tidak valid dari server.");
            }
        };

        const renderProducts = (category = 'all') => {
            productGrid.innerHTML = ''; 
            const filteredProducts = category === 'all' 
                ? state.products 
                : state.products.filter(p => p.category && p.category.toLowerCase().trim() === category);

            if (filteredProducts.length === 0) {
                const message = category === 'all' ? "Menu belum ditambahkan di Google Sheet." : "Menu tidak ditemukan untuk kategori ini.";
                productGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">${message}</p>`;
                return;
            }

            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg transform hover:-translate-y-1 transition-transform duration-300';
                productCard.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="w-full h-32 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/300x300/334155/f1f5f9?text=Image+Error';">
                    <div class="p-4">
                        <h3 class="font-bold text-md truncate">${product.name}</h3>
                        <p class="text-emerald-400 font-semibold mt-1">${formatCurrency(product.price)}</p>
                        <button data-id="${product.id}" class="add-to-cart-btn w-full mt-3 bg-gray-700 text-emerald-400 py-2 rounded-lg font-semibold hover:bg-emerald-500 hover:text-white transition-colors flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span>Tambah</span>
                        </button>
                    </div>
                `;
                productGrid.appendChild(productCard);
            });
            lucide.createIcons();
        };
        
        const renderCart = () => {
            const totalItems = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCountBadge.textContent = totalItems;
            cartCountBadge.classList.toggle('hidden', totalItems === 0);

            if (state.currentView !== 'cart') return;

            if (state.cart.length === 0) {
                cartItemsContainer.innerHTML = '';
                emptyCartMessage.classList.remove('hidden');
                cartSummary.classList.add('hidden');
            } else {
                emptyCartMessage.classList.add('hidden');
                cartSummary.classList.remove('hidden');
                cartItemsContainer.innerHTML = state.cart.map(item => `
                    <div class="flex items-center gap-4 mb-4 bg-gray-800 p-3 rounded-lg">
                        <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/100x100/334155/f1f5f9?text=Img';">
                        <div class="flex-grow">
                            <h4 class="font-semibold">${item.name}</h4>
                            <p class="text-gray-400">${formatCurrency(item.price)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button data-id="${item.id}" class="update-quantity-btn dec-btn p-1 bg-gray-700 rounded-full hover:bg-gray-600 transition-colors">
                                <i data-lucide="minus" class="w-4 h-4"></i>
                            </button>
                            <span class="font-bold w-6 text-center">${item.quantity}</span>
                             <button data-id="${item.id}" class="update-quantity-btn inc-btn p-1 bg-gray-700 rounded-full hover:bg-gray-600 transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <button data-id="${item.id}" class="remove-from-cart-btn p-2 text-gray-500 hover:text-red-500 transition-colors">
                             <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                `).join('');
                updateCartSummary();
            }
            lucide.createIcons();
        };
        
        const updateCartSummary = () => {
            const subtotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            subtotalAmountEl.textContent = formatCurrency(subtotal);
            totalAmountEl.textContent = formatCurrency(subtotal);
            paymentTotalAmountEl.textContent = formatCurrency(subtotal);
        };

        const switchView = (view) => {
            state.currentView = view;
            [menuView, cartView, paymentView].forEach(v => v.classList.add('hidden'));
            document.getElementById(`${view}-view`).classList.remove('hidden');
            if (view === 'cart') renderCart();
        };

        const updateDeliveryNoticeVisibility = () => {
            const showNotice = state.orderType === 'delivery' && state.paymentMethod === 'transfer';
            deliveryPaymentNotice.classList.toggle('hidden', !showNotice);
        };

        const handleCategoryClick = (e) => {
            const target = e.target.closest('.category-btn');
            if (!target) return;
            categoryBtns.forEach(btn => {
                btn.classList.remove('bg-emerald-500', 'text-white');
                btn.classList.add('bg-gray-700', 'text-gray-300');
            });
            target.classList.add('bg-emerald-500', 'text-white');
            target.classList.remove('bg-gray-700', 'text-gray-300');
            renderProducts(target.dataset.category);
        };

        const handleProductGridClick = (e) => {
            const target = e.target.closest('.add-to-cart-btn');
            if (!target) return;
            const productId = parseInt(target.dataset.id);
            const product = state.products.find(p => p.id === productId);
            const cartItem = state.cart.find(item => item.id === productId);
            if (cartItem) cartItem.quantity++;
            else state.cart.push({ ...product, quantity: 1 });
            
            target.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Ditambahkan!`;
            target.classList.add('bg-emerald-500', 'text-white');
            lucide.createIcons();
            setTimeout(() => {
                target.innerHTML = `<i data-lucide="plus" class="w-4 h-4"></i> <span>Tambah</span>`;
                target.classList.remove('bg-emerald-500', 'text-white');
                lucide.createIcons();
            }, 1000);
            renderCart();
        };

        const handleCartItemsClick = (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const productId = parseInt(target.dataset.id);
            if (target.classList.contains('update-quantity-btn')) {
                const cartItem = state.cart.find(item => item.id === productId);
                if (target.classList.contains('inc-btn')) cartItem.quantity++;
                else if (target.classList.contains('dec-btn')) {
                    cartItem.quantity--;
                    if (cartItem.quantity === 0) state.cart = state.cart.filter(item => item.id !== productId);
                }
            } else if (target.classList.contains('remove-from-cart-btn')) {
                state.cart = state.cart.filter(item => item.id !== productId);
            }
            renderCart();
        };
        
        const handleOrderTypeClick = (e) => {
            const target = e.target.closest('.order-type-btn');
            if (!target) return;
            state.orderType = target.dataset.type;
            orderTypeBtns.forEach(btn => btn.classList.remove('ring-2', 'ring-emerald-500'));
            target.classList.add('ring-2', 'ring-emerald-500');
            deliveryAddressContainer.classList.toggle('hidden', state.orderType !== 'delivery');

            const cashBtn = document.querySelector('.payment-method-btn[data-payment="cash"]');
            const transferBtn = document.querySelector('.payment-method-btn[data-payment="transfer"]');

            if (state.orderType === 'delivery') {
                cashBtn.disabled = true;
                cashBtn.classList.add('opacity-50', 'cursor-not-allowed');
                
                if (state.paymentMethod === 'cash') {
                    state.paymentMethod = 'transfer';
                    cashBtn.classList.remove('ring-2', 'ring-emerald-500');
                    transferBtn.classList.add('ring-2', 'ring-emerald-500');
                    transferInfo.classList.remove('hidden');
                }
            } else {
                cashBtn.disabled = false;
                cashBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            updateDeliveryNoticeVisibility();
        };

        const handlePaymentMethodClick = (e) => {
            const target = e.target.closest('.payment-method-btn');
            if (!target || target.disabled) return;
            
            state.paymentMethod = target.dataset.payment;
            paymentMethodBtns.forEach(btn => btn.classList.remove('ring-2', 'ring-emerald-500'));
            target.classList.add('ring-2', 'ring-emerald-500');
            transferInfo.classList.toggle('hidden', state.paymentMethod !== 'transfer');
            updateDeliveryNoticeVisibility();
        };

        const handleSendOrder = async () => {
            const customerName = customerNameInput.value.trim();
            const customerPhone = customerPhoneInput.value.trim();
            const deliveryAddress = deliveryAddressInput.value.trim();

            if (state.cart.length === 0) return alert('Keranjang belanja kosong!');
            if (!customerName || !customerPhone) return alert('Nama dan Nomor WhatsApp pelanggan wajib diisi!');
            if (state.orderType === 'delivery' && !deliveryAddress) return alert('Alamat pengiriman wajib diisi untuk pesanan delivery!');
            if (GOOGLE_APPS_SCRIPT_URL === '') return alert('Konfigurasi Error: URL Google Apps Script belum diisi.');
            
            const confirmBtnText = document.getElementById('confirm-btn-text');
            const confirmBtnLoader = document.getElementById('confirm-btn-loader');
            confirmOrderBtn.disabled = true;
            confirmBtnText.classList.add('hidden');
            confirmBtnLoader.classList.remove('hidden');
            
            const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const orderData = {
                timestamp: new Date().toISOString(),
                customerName, customerPhone, paymentMethod: state.paymentMethod, totalAmount: total,
                items: JSON.stringify(state.cart.map(item => ({ name: item.name, qty: item.quantity, price: item.price }))),
                orderType: state.orderType,
                deliveryAddress: state.orderType === 'delivery' ? deliveryAddress : '',
            };

            try {
                await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors', cache: 'no-cache',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(orderData), redirect: 'follow',
                });
                
                successModal.classList.remove('hidden');
                successModal.classList.add('modal-enter');
                resetApp();
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat mengirim data. Pastikan koneksi internet Anda stabil.');
            } finally {
                confirmOrderBtn.disabled = false;
                confirmBtnText.classList.remove('hidden');
                confirmBtnLoader.classList.add('hidden');
            }
        };

        const resetApp = () => {
            state.cart = [];
            state.paymentMethod = 'cash';
            state.orderType = 'dine-in';
            customerNameInput.value = '';
            customerPhoneInput.value = '';
            deliveryAddressInput.value = '';
            paymentMethodBtns.forEach(btn => btn.classList.remove('ring-2', 'ring-emerald-500'));
            document.querySelector('.payment-method-btn[data-payment="cash"]').classList.add('ring-2', 'ring-emerald-500');
            orderTypeBtns.forEach(btn => btn.classList.remove('ring-2', 'ring-emerald-500'));
            document.querySelector('.order-type-btn[data-type="dine-in"]').classList.add('ring-2', 'ring-emerald-500');
            deliveryAddressContainer.classList.add('hidden');
            transferInfo.classList.add('hidden');
            renderCart();
            switchView('menu');
        };

        const closeSuccessModal = () => {
            successModal.classList.add('modal-leave');
            setTimeout(() => {
                successModal.classList.add('hidden');
                successModal.classList.remove('modal-enter', 'modal-leave');
            }, 300);
        };
        
        const fetchProducts = async () => {
             if (GOOGLE_APPS_SCRIPT_URL === '') {
                productGrid.innerHTML = `<p class="col-span-full text-center text-red-400"><b>Konfigurasi Error:</b> URL Google Apps Script belum diisi. Silakan cek file PETUNJUK.md.</p>`;
                return;
            }
            try {
                const products = await robustJsonFetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getProducts`);
                state.products = products;
                renderProducts();
            } catch (error) {
                console.error("Could not fetch products:", error);
                productGrid.innerHTML = `<p class="col-span-full text-center text-red-400"><b>Gagal memuat menu.</b><br>Pastikan URL Apps Script benar dan sheet 'Produk' sudah ada.</p>`;
            }
        };

        // EVENT LISTENERS
        categoryBtns.forEach(btn => btn.addEventListener('click', handleCategoryClick));
        productGrid.addEventListener('click', handleProductGridClick);
        cartItemsContainer.addEventListener('click', handleCartItemsClick);
        cartButton.addEventListener('click', () => switchView('cart'));
        backToMenuBtn.addEventListener('click', () => switchView('menu'));
        backToCartBtn.addEventListener('click', () => switchView('cart'));
        checkoutBtn.addEventListener('click', () => switchView('payment'));
        orderTypeBtns.forEach(btn => btn.addEventListener('click', handleOrderTypeClick));
        paymentMethodBtns.forEach(btn => btn.addEventListener('click', handlePaymentMethodClick));
        confirmOrderBtn.addEventListener('click', handleSendOrder);
        closeModalBtn.addEventListener('click', closeSuccessModal);

        // INITIAL LOAD
        fetchProducts();
        lucide.createIcons();
    });
    </script>
</body>
</html>
